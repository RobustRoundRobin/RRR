interpreter: bash -c
name: rrrbuild
options:
  workdir:
    usage: >
      The common root for everything we need. All defaults are relative to this
    environment: PWD

# Runes for building things
tasks:

  all:
    run:
      - task: test
      - task: images

  images:
    options:
      build:
        short: "b"
        default: ""

    run:
      - command:
          exec: |
            set -e
            [ ! -d ${workdir}/quorum ] && echo "RobustRoundRobin/quorum git clone missing" && exit 1
            [ ! -d ${workdir}/go-rrr ] && echo "RobustRoundRobin/go-rrr git clone missing" && exit 1

            RRR_DIR=$(pwd)
            cd ${workdir}
            [ ! -f skaffold.yaml ] && ln -s $(pwd)/buildcontext/skaffold.yaml skaffold.yaml
            [ ! -f .dockerignore ] && ln -s $(pwd)/buildcontext/.dockeringore .dockerignore
            [ ! -f Dockerfile ] && ln -s $(pwd)/buildcontext/Dockerfile Dockerfile
            [ ! -f Dockerfile-rrrctl ] && ln -s $(pwd)/buildcontext/Dockerfile Dockerfile-rrrctl

            TAG=fetlar-ntp

            BUILD=""
            [ "${build}" != "" ] && BUILD="-b ${build}"

            export SKAFFOLD_DEFAULT_REPO="eu.gcr.io/fetlar-1"
            skaffold build -t $TAG $BUILD

            docker tag $SKAFFOLD_DEFAULT_REPO/geth-rrr:$TAG geth-rrr:latest
            docker tag $SKAFFOLD_DEFAULT_REPO/rrrctl:$TAG rrrctl:latest

  test:
    run:
      - command:
          exec: |
            set -e
            cd ../go-rrr/tools
            go test -timeout 300s -v github.com/RobustRoundRobin/go-rrr/tools
