interpreter: bash -c
name: rororo-genesis

tasks:
  set-build-env:
    run:
      # OPINIONS EXPRESSED HERE
      # see tusk.yaml for explanations
      - set-environment:
          QUORUM_GOPATH: "../quorum-rororo-gopath"
          DEFAULT_NODE_DIR: "../rororo-nodes/node0"
          BOOTNODE_DIR: "../rororo-nodes/bootnode"
          NODES_DIR: "../rororo-nodes"

  init-all:
    usage: "genesis for all nodes in range [start - end]"
    options:
      start:
        short: "s"
        default: "0"
      end:
        short: "e"
        default: "11"

    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            for n in $(seq ${start} ${end}); do
              tusk -q -f tusk-genesis.yaml genesis -n ${n} -f
              mkdir -p $(pwd)/${NODES_DIR}/node${n}/data/geth
              cp static-nodes.json $(pwd)/${NODES_DIR}/node${n}/data/geth/
            done

  reset-all:
    usage: "run geth removedb on all nodes"
    options:
      start:
        short: "s"
        default: "0"
      end:
        short: "e"
        default: "11"

    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            export GOPATH=$(cd $QUORUM_GOPATH; pwd)

            for n in $(seq ${start} ${end}); do
              DATA_DIR=$(pwd)/${NODES_DIR}/node${n}/data
              go run github.com/ethereum/go-ethereum/cmd/geth removedb --datadir ${DATA_DIR}
            done

  keys:
    usage: "generate a range of keys"
    options:
      start:
        short: "s"
        default: "0"
      end:
        short: "e"
        default: "11"
    run:
      - command:
          exec: |
            set -e
            for n in $(seq ${start} ${end}); do
              tusk -q -f tusk-genesis.yaml nodekey -n ${n} -f
            done
  extra:
    usage: "generate the extradata hex string for the genesi document"
    options:
      start:
        short: "s"
        default: "0"
      end:
        short: "e"
        default: "11"
      force:
        usage: "Force delete of existing datadir"
        type: bool
        short: "f"

    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            export GOPATH=$(cd $QUORUM_GOPATH; pwd)

            if ${force}; then echo "force deleting $(pwd)/static-nodes.json"; rm -f $(pwd)/static-nodes.json; fi
            [ -f $(pwd)/static-nodes.json ] && echo "$(pwd)/static-nodes.json exists, -f to force delete" && exit 1

            # the node that runs genesis gets to enrol whatever identities it
            # likes
            NODE_DIR=$(pwd)/${NODES_DIR}/node0

            endend=$((${end} - 1))

            # go-ethereum's support for parsing enode urls (which we use for
            # convenience) also, perplexingly, resolves the dns names at the
            # time it parses the url. For docker compose setup, and for cluster
            # setup, this is quite inconvenient - so we generate two 'static'
            # node configuration files: one so that we can generate the extra
            # data and another that we actually use. Only the host names are
            # different and this does not affect the extraData
            #
            rm -rf static-nodes.json static-nodes-loopback.json

            echo "[" | tee -a static-nodes-loopback.json
            for n in $(seq ${start} ${endend}); do
              printf "\"enode://$(cat $(pwd)/${NODES_DIR}/node${n}/enode)@127.0.0.1:7200\",\n" | tee -a static-nodes-loopback.json
            done
            printf "\"enode://$(cat $(pwd)/${NODES_DIR}/node${end}/enode)@127.0.0.1:7200\"\n" | tee -a static-nodes-loopback.json
            echo "]" | tee -a static-nodes-loopback.json

            echo "[" | tee -a static-nodes.json
            for n in $(seq ${start} ${endend}); do
              printf "\"enode://$(cat $(pwd)/${NODES_DIR}/node${n}/enode)@node${n}:7200\",\n" | tee -a static-nodes.json
            done
            printf "\"enode://$(cat $(pwd)/${NODES_DIR}/node${end}/enode)@node${end}:7200\"\n" | tee -a static-nodes.json
            echo "]" | tee -a static-nodes.json

            # attempts to resolve the node's and that doesn't work out side of
            # compose
            go run github.com/ethereum/go-ethereum/cmd/rororo genextra --datadir ${NODE_DIR} $(pwd)/static-nodes-loopback.json


  genesis:
    usage: "do genesis (using go run and sources in quorum-rororo)"
    options:
      node:
        usage: "node number"
        short: "n"
        default: "0"
      datadir:
        usage: "geth init --datadir, defaults to NODES_DIR/node0/data"
        default: ""
        short: "d"
      genesis:
        usage: "genesis.json file, defaults to datadir/../gensis.json"
        default: ""
        short: "G"
      force:
        usage: "Force delete of existing datadir"
        type: bool
        short: "f"

    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            export GOPATH=$(cd $QUORUM_GOPATH; pwd)
            TASK_DIR=$(pwd)

            [ -n "${genesis}" ] && "${TASK_DIR}/${genesis}" || GENESIS_JSON="${TASK_DIR}/${NODES_DIR}/node0/genesis.json"
            [ -n "${node}" ] && NODE_DIR="${TASK_DIR}/${NODES_DIR}/node${node}" || NODE_DIR="${TASK_DIR}/${NODES_DIR}/node0"
            [ -n "${datadir}" ] && DATA_DIR="${TASK_DIR}/${datadir}" || DATA_DIR=${NODE_DIR}/data

            if ${force}; then echo "force deleting: ${DATA_DIR}"; rm -rf ${DATA_DIR}; fi

            [ -d ${DATA_DIR} ] && echo "datadir exists, -f to force delete" && exit 1

            mkdir -p ${DATA_DIR} && cd ${DATA_DIR}
            DATA_DIR=$(pwd)
            # --rororo.endorsers 101

            go run github.com/ethereum/go-ethereum/cmd/geth \
              --datadir=${DATA_DIR} init ${GENESIS_JSON}

            echo "${DATA_DIR} from ${GENESIS_JSON}"

  nodekey:
    usage: "generate node key (using go run and sources in quorum-rororo)"
    options:

      node:
        usage: "node number"
        short: "n"
        default: "0"

      key:
        usage: "output file name or '/dev/stdout'"
        default: "key"
      enode:
        usage: "output file name or '/dev/stdout'"
        default: "enode"

      force:
        usage: "Force overwrite of existing key"
        type: bool
        short: "f"

    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            export GOPATH=$(cd $QUORUM_GOPATH; pwd)

            TASK_DIR=$(pwd)

            if [[ "${key}" != "/dev/stdout" ]] || [[ "${enode}" != "/dev/stdout" ]]; then
              [ -n "${node}" ] && NODE_DIR="${TASK_DIR}/${NODES_DIR}/node${node}" || NODE_DIR="${TASK_DIR}/${NODES_DIR}/node0"
              mkdir -p ${NODE_DIR} && cd ${NODE_DIR}
            fi

            # Note that [ -f /dev/stdout ] is FALSE, so we don't need to guard
            # against deleting it

            if ${force}; then
              [ -f ${key} ] && echo "force deleting: ${key}" && rm -f ${key}
              [ -f ${enode} ] && echo "force deleting: ${enode}" && rm -f ${enode}
            fi
            [[ -f "${key}" || -f "${enode}" ]] && echo "key or enode exist: ${key}, ${enode}. -f to force delete" && exit 1

            KEY=$(go run github.com/ethereum/go-ethereum/cmd/bootnode --genkey /dev/stdout)
            ENODE=$(echo $KEY | go run github.com/ethereum/go-ethereum/cmd/bootnode --nodekey /dev/stdin --writeaddress)
            echo $KEY > ${key} && echo "wrote: ${key}"
            echo $ENODE > ${enode} && echo "wrote: ${enode}"
            pwd
