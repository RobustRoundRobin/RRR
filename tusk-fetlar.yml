# https://github.com/rliebz/tusk
interpreter: bash -c
usage: "tasks for working with the fetlar gcp test cluster"
name: rrr-fetlar
options:
  configdir:
    usage: >
      The common root for everything we need. All defaults are relative to this
    environment: PWD
  workdir:
    usage: >
      The directory containing all the repos we need go-rrr, quorum etc
    default:
      command: echo $(cd $(git rev-parse --show-toplevel)/..; pwd)

tasks:

  jump:
    run:
      - command:
          exec: |
            set -e
            kubectl -n monitoring run -i --tty --image=alpine:latest --restart=Never -- sh

  blocksdb:
    options:
      force:
        usage: "add --force to apply"
        short: "f"
        type: bool

      start:
        short: "s"
      end:
        short: "e"

      endpoint:
        default: "http://127.0.0.1:8300"

    run:
      - command:
          exec: |
            set -e
            dbfile=$(pwd)/rrrblocks.db
            ${force} && rm $dbfile
            cd ../go-rrr/tools
            echo "blocksdb file: ${dbfile}"
            time go run cmd/rrrctl/main.go \
              inspectheaders \
                --endpoint ${endpoint} \
                --dbshare \
                --dbname ${dbfile} \
                --start ${start} --end ${end}
            echo "done. blocksdb file: ${dbfile}"

  up:
    options:
      force:
        usage: "add --force to apply"
        short: "f"
        type: bool
    run:
      - command:
          exec: |
            set -e
            kubectl apply -k k8s/fetlar/ledger $(${force} && echo "--force")

  down:
    run:
      - command:
          exec: |
            set -e
            kubectl delete -k k8s/fetlar/ledger

  images:
    run:
      - command:
          exec: |
            set -e
            [ ! -d ${workdir}/quorum ] && echo "RobustRoundRobin/quorum git clone missing" && exit 1
            [ ! -d ${workdir}/go-rrr ] && echo "RobustRoundRobin/go-rrr git clone missing" && exit 1

            RRR_DIR=$(pwd)
            cd ${workdir}
            [ ! -f skaffold.yaml ] && ln -s $(pwd)/buildcontext/skaffold.yaml skaffold.yaml
            [ ! -f .dockerignore ] && ln -s $(pwd)/buildcontext/.dockeringore .dockerignore
            [ ! -f Dockerfile ] && ln -s $(pwd)/buildcontext/Dockerfile Dockerfile
            [ ! -f Dockerfile-rrrctl ] && ln -s $(pwd)/buildcontext/Dockerfile Dockerfile-rrrctl

            TAG=fetlar-ntp

            export SKAFFOLD_DEFAULT_REPO="eu.gcr.io/fetlar-1"
            skaffold build -t $TAG

            docker tag $SKAFFOLD_DEFAULT_REPO/geth-rrr:$TAG geth-rrr:latest
            docker tag $SKAFFOLD_DEFAULT_REPO/rrrctl:$TAG rrrctl:latest



  deploygenesis:
    usage: "update the network genesis parameters (IMPLIES CHAIN RESET or INIT)"
    options:
      end:
        usage: "how many identities to enrole in genesis (up to the max you have deployed keys for)"
        short: "e"
        default: "29"
    run:
      - command:
          exec: |
            set -e
            cd $(git rev-parse --show-toplevel)

            pushd tf/fetlar/ledger
            TFOUT_LEDGER=$(terraform output -json)
            PROJECT=$(echo "$TFOUT_LEDGER" | jq -r .gcp_project_id.value)
            BUCKET=$(echo "$TFOUT_LEDGER" | jq -r .cluster_bucket.value)
            popd

            tools/gcpblob.py -t "$TOKEN" -p "$PROJECT" -b $BUCKET \
              post network-genesis/genesis.json \
                --datafile <(tusk -q -f $(pwd)/tusk-fetlar.yml gendoc --workdir ${workdir} -s 0 -e ${end})

  gendoc:
    usage: "create a genesis document from a template doc and alpha contributions"
    options:
      account:
        usage: "the wallet to allocate the genesis balance to - suggest you change the default!"
        short: "w"
        default:
          command: echo $(tools/gcpsecrets.sh getsecret -x qnode-0-wallet-address)
      balance:
        usage: "The balance to allocate to the genesis-account"
        default: "1000000000000000000000000000"

      template:
        usage: "template file to use. by default genesis.json from this repo is used"
        short: "g"
        default: ""
      start:
        short: "s"
        default: "0"
      end:
        short: "e"
        default: "29"

    run:
      - command:
          exec: |
            set -e

            export EXTRADATA=$(tusk -q -f $(pwd)/tusk-fetlar.yml \
              extra \
                --configdir ${configdir} \
                --workdir ${workdir} \
                -s ${start} -e ${end})

            cat <<PYEND | python3
            import os
            import json
            from pathlib import Path
            templatefile = "${template}"
            if not templatefile:
                templatefile = Path("genesis.json").resolve()
            else:
                templatefile = Path("${workdir}").joinpath(templatefile)

            o = json.load(open(templatefile))
            try:
                del o["alloc"]["0x0000000000000000000000000000000000000000"]
            except KeyError:
                pass
            o["alloc"]["${account}"] = dict(balance="${balance}")

            extraData = os.environ["EXTRADATA"]
            if not extraData.startswith("0x"):
                extraData = "0x" + extraData
            o["extraData"] = extraData
            print(json.dumps(o, indent=2, sort_keys=True))
            PYEND

  ensuresecrets:
    options:
      start:
        short: "s"
        default: "0"
      end:
        short: "e"
        default: "29"

    run:
      - command:
          exec: |

            for i in $(seq ${start} ${end})
            do
              tools/gcpsecrets.sh nodekey qnode-$i-
              tools/gcpsecrets.sh wallet qnode-$i-wallet-
            done

  deletesecrets:
    options:
      start:
        short: "s"
        default: "0"
      end:
        short: "e"
        default: "29"

    run:
      - command:
          exec: |

            NAMES=""

            for i in $(seq ${start} ${end})
            do
              NAMES="$NAMES qnode-$i-key qnode-$i-enode qnode-$i-wallet-key qnode-$i-wallet-pub qnode-$i-wallet-password qnode-$i-wallet-address"
            done
            tools/gcpsecrets.sh delete $NAMES

  extra:
    usage: "Generate the extradata for genesis"
    options:
      start:
        short: "s"
        default: "0"
      end:
        short: "e"
        default: "29"

    run:
      - command:
          exec: |
            KEY0=$(tools/gcpsecrets.sh getnodekey qnode-0-key)
            ALPHA=""
            for i in $(seq ${start} ${end})
            do
              rm -f alpha-$i.json


              tools/gcpsecrets.sh signalpha qnode-$i-key > ${configdir}/alpha-$i.json
              echo $(cat ${configdir}/alpha-$i.json) 1>&2
              ALPHA="$ALPHA ${configdir}/alpha-$i.json"
            done

            cd ${workdir}/go-rrr/tools
            go run cmd/rrrctl/main.go genextra \
               --keyhex $KEY0 \
               $ALPHA
