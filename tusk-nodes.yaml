interpreter: bash -c

# This probably is NOT THE DROID
#
# Unless you really want to develop on your host, with your nodes exposed over
# UPnP (its a good test of resilience against random messages), the compose
# support is likely easier to work with.

name: rororo-nodes
tasks:
  set-build-env:
    run:

      # OPINIONS EXPRESSED HERE see tusk.yaml for explanations
      - set-environment:
          NETWORKID: "53456"
          QUORUM_GOPATH: "../quorum-rororo-gopath"
          DEFAULT_NODE_DIR: "../rororo-nodes/node0"
          BOOTNODE_DIR: "../rororo-nodes/bootnode"
          NODE1_DIR: "../rororo-nodes/node1"
          NODE2_DIR: "../rororo-nodes/node2"
          BOOTNODE_ENODE: "enode://85fb8ceeb849caace57ee5adac0d644f0d1f57f097c305677f98b3dc59ead2c97b3ffc4320007487238f16cd3338eeaf0092f845b8dbc284751a9bc6431d059c@127.0.0.1:7199?discport=30301"
          NETRESTRICT: "--netrestrict 127.0.0.1/24"
          DISCOVERY_OPTS: "--nodiscover --netrestrict 127.0.0.1/24"
          # DISCOVERY_OPTS: "--bootnodes enode://85fb8ceeb849caace57ee5adac0d644f0d1f57f097c305677f98b3dc59ead2c97b3ffc4320007487238f16cd3338eeaf0092f845b8dbc284751a9bc6431d059c@127.0.0.1:7199?discport=30301"
          RORORO_OPTS: "--rororo.candidates 6 --rororo.endorsers 101"
          RPC_OPTS: "\
           --rpc \
           --rpcapi 'admin,db,eth,debug,miner,net,shh,txpool,personal,web3,quorum' \
           --rpccorsdomain '*' \
           --rpcvhosts '*' \
           --rpcaddr 0.0.0.0"
          WS_OPTS: "--ws --wsorigins '*' --wsaddr 0.0.0.0"
          MINER_OPTS: "\
           --miner.gastarget 3000000000 \
           --mine --minerthreads 1 --miner.etherbase 0xfddc8ec119e799a3fb2c3455cabe72a1bd59fb5a"
          LOG_OPTS: "--vmodule 'p2p/*=7' --verbosity 7"

  bootnode:
    usage: "run a bootnode"
    options:
      nodedir:
        usage: "parent dir for node --datadir, defaults to BOOTNODE_DIR"
        default: ""

    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            export GOPATH=$(cd ${QUORUM_GOPATH}; pwd)
            [ -n "${nodedir}" ] && NODE_DIR="${nodedir}" || NODE_DIR=${BOOTNODE_DIR}

            export NODE_DIR=$(mkdir -p ${NODE_DIR} && cd ${NODE_DIR}; pwd)
            export DATA_DIR=$(mkdir -p ${NODE_DIR}/data && cd ${NODE_DIR}/data; pwd)

            export PRIVATE_CONFIG=ignore
            go run github.com/ethereum/go-ethereum/cmd/geth \
                --port 30301 \
                --nat "extip:127.0.0.1" ${NETRESTRICT} \
                --networkid ${NETWORKID} \
                --nodekey ${NODE_DIR}/key \
                --datadir ${DATA_DIR} \
                ${LOG_OPTS}

  node1:
    usage: "run a node"
    options:
      nodedir:
        usage: "parent dir for node --datadir, defaults to NODE1_DIR"
        default: ""

    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            export GOPATH=$(cd ${QUORUM_GOPATH}; pwd)
            [ -n "${nodedir}" ] && NODE_DIR="${nodedir}" || NODE_DIR=${NODE1_DIR}
            export DATA_DIR=$(mkdir -p ${NODE_DIR}/data && cd ${NODE_DIR}/data; pwd)
            export PRIVATE_CONFIG=ignore

            go run github.com/ethereum/go-ethereum/cmd/geth \
                --networkid ${NETWORKID} \
                ${DISCOVERY_OPTS} \
                --port 7201 \
                --nodekey ${NODE_DIR}/key \
                --datadir ${DATA_DIR} \
                --gcmode archive  --syncmode full \
                ${MINER_OPTS} \
                --rpcport 8301 ${RPC_OPTS} \
                --wsport 8401 ${WS_OPTS} \
                ${LOG_OPTS}

  node2:
    usage: "run a node"
    options:
      nodedir:
        usage: "parent dir for node --datadir, defaults to NODE2_DIR"
        default: ""

    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            export GOPATH=$(cd ${QUORUM_GOPATH}; pwd)
            [ -n "${nodedir}" ] && NODE_DIR="${nodedir}" || NODE_DIR=${NODE2_DIR}
            export DATA_DIR=$(mkdir -p ${NODE_DIR}/data && cd ${NODE_DIR}/data; pwd)
            export PRIVATE_CONFIG=ignore

            go run github.com/ethereum/go-ethereum/cmd/geth \
                --networkid ${NETWORKID} \
                ${DISCOVERY_OPTS} \
                --port 7202 \
                --nodekey ${NODE_DIR}/key \
                --datadir ${DATA_DIR} \
                --gcmode archive  --syncmode full \
                ${MINER_OPTS} \
                --rpcport 8302 ${RPC_OPTS} \
                --wsport 8402 ${WS_OPTS} \
                ${LOG_OPTS}

  node0:
    usage: "run a node"
    options:
      nodedir:
        usage: "parent dir for node --datadir, defaults to DEFAULT_NODE_DIR"
        default: ""

    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            export GOPATH=$(cd ${QUORUM_GOPATH}; pwd)
            [ -n "${nodedir}" ] && NODE_DIR="${nodedir}" || NODE_DIR=${DEFAULT_NODE_DIR}
            export DATA_DIR=$(mkdir -p ${NODE_DIR}/data && cd ${NODE_DIR}/data; pwd)
            export PRIVATE_CONFIG=ignore

            go run github.com/ethereum/go-ethereum/cmd/geth \
                --networkid ${NETWORKID} \
                ${DISCOVERY_OPTS} \
                --port 7200 \
                --nodekey ${NODE_DIR}/key \
                --datadir ${DATA_DIR} \
                --gcmode archive  --syncmode full \
                ${MINER_OPTS} \
                --rpcport 8300 ${RPC_OPTS} \
                --wsport 8400 ${WS_OPTS} \
                ${LOG_OPTS}
