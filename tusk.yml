interpreter: bash -c

# NOTICE: Some of these arrangements are very transitory. Once we have things
# rolling, this repository may/should ? get completely removed. It may become a
# long term home for shared developer conveniences.
#
# This tusk file has some hard opinions about the *relative* location and
# directory names for RRR's quorum fork and rororo go package.
options:
  node:
    default: "0"
    short: "n"
  nodedir:
    usage: "parent dir for node --datadir"
    default:
      command: echo $(cd ../rororo-nodes/node0; pwd)

  gopath:
    default:
      command: echo $(cd ../quorum-rororo-gopath; pwd)

name: rororodev
tasks:

  rawtx:
    usage: "generate a raw transaction (of arbitrary kind)"
    options:
      nonce:
        default: "0"
    run:
      - command:
          exec: |
            set -e
            # SimpleStorage needs support for contract constructor parameters
            # encode truffle/build/contracts/SimpleStorage.json
            python3 rawtx.py -v \
              encode truffle/build/contracts/Migrations.json \
              --nonce ${nonce} \
              -k ../rororo-nodes/node0/genesis-wallet.key

  attach:
    usage: "geth attach using docker exec go run"

    run:
      - command:
          exec: |
            set -e
            docker exec -it rororo_node${node}_1 \
              geth attach /nodes/node${node}/data/geth.ipc

  gethjex:
    usage: "geth attach --exec using docker exec go run"
    options:
      node:
        default: "1"
        short: "n"
    args:
      exec:
    run:
      - command:
          exec: |
            set -e
            docker exec -it rororo_node${node}_1 \
              go run github.com/ethereum/go-ethereum/cmd/geth \
              attach /nodes/node${node}/data/geth.ipc --exec "${exec}"

  address:
    usage: "get the wallet address from a key"
    options:
      key:
        usage: "binary format key file"
        short: "k"
      hex_key:
        usage: "hex format key file"
        short: "x"
      hex_pub:
        usage: "hex format public key"

    run:
      - command:
          exec: |
            set -e
            mkdir -p ${nodedir} && cd ${nodedir}

            cat <<PYEND | python
            import secrets, coincurve, sha3

            if "${key}" != "":
                pub = coincurve.PublicKey.from_valid_secret(open("${key}", "rb").read())
                addr = sha3.keccak_256(pub.format(compressed=False)[1:]).digest()[-20:].hex()
                print(f"key: {addr}")
            PYEND
  wallet:
    usage: "create a wallet (python deps: sha3, coincurve)"
    options:
      name:
        usage: "basename for wallet files .key, .pub and .addr"
        default: genesis-wallet
    run:
      - command:
          exec: |
            set -e
            mkdir -p ${nodedir} && cd ${nodedir}

            cat <<PYEND | python
            import secrets, coincurve, sha3

            key = sha3.keccak_256(secrets.token_bytes(32)).digest()
            keyhex = key.hex()
            pub = coincurve.PublicKey.from_valid_secret(key).format(compressed=False)[1:]
            addr = "0x" + sha3.keccak_256(pub).digest()[-20:].hex()

            for var, mode in [("keyhex", ""), ("key", "b"), ("pub", "b"), ("addr", "")]:
                with open(f"${name}.{var}", "w" + mode) as f:
                    f.write(locals()[var])

            print(addr)
            PYEND

  import-wallet:
    usage: "imports the genesis account so unsigned transactions can be issued via console and rpc"
    options:
      password:
        usage: "set the password"
        short: "p"
        default: "genesis"
      name:
        usage: "basename for wallet files .key, .pub and .addr"
        default: genesis-wallet
    run:
      - command:
          exec: |
            set -e
            export GOPATH=${gopath}
            NODE_DIR=${nodedir}

            mkdir -p ${NODE_DIR}/data/keystore
            export PRIVATE_CONFIG=ignore
            echo "${password}" > ${NODE_DIR}/${name}.password
            go run github.com/ethereum/go-ethereum/cmd/geth \
              --password ${NODE_DIR}/${name}.password \
              --datadir=${NODE_DIR}/data \
              --keystore=${NODE_DIR}/data/keystore \
              account import ${NODE_DIR}/${name}.keyhex
