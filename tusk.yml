interpreter: bash -c

# NOTICE: Some of these arrangements are very transitory. Once we have things
# rolling, this repository may/should ? get completely removed. It may become a
# long term home for shared developer conveniences.
#
# This tusk file has some hard opinions about the *relative* location and
# directory names for RoRoRo's quorum fork and rororo go package.

name: rororodev
tasks:
  set-build-env:
    run:

      # OPINIONS EXPRESSED HERE
      #
      # set-environment does not support sh eval, so we can't do very much
      # here. All the relative paths must be resolved by the task definitions
      # which rely on them. These only affect tasks which run on the host.
      # Those that exec into docker are dependent on the compose files
      - set-environment:
          # GOPATH
          #
          # For quorum's fork, this is where GOPATH should point. upstream
          # go-ethereum has moved over to go.mod but quorum has not caught up
          # with that yet.
          QUORUM_GOPATH: "../quorum-rororo-gopath"

          # tools and tests which need to do genesis and generate wallets and
          # so on will treat all directories under this path as 'scratch'
          DEFAULT_NODE_DIR: "../rororo-nodes/node0"

  attach:
    usage: "geth attach using docker exec go run"
    options:
      node:
        default: "1"
        short: "n"

    run:
      - command:
          exec: |
            set -e
            docker exec -it rororo_node${node}_1 \
              go run github.com/ethereum/go-ethereum/cmd/geth attach /nodes/node${node}/data/geth.ipc

  gethjex:
    usage: "geth attach --exec using docker exec go run"
    options:
      node:
        default: "1"
        short: "n"
      exec:
        required: true
        short: "e"
    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            docker exec -it rororo_node${node}_1 \
              go run github.com/ethereum/go-ethereum/cmd/geth \
              attach /nodes/node${node}/data/geth.ipc --exec ${exec}

  wallet:
    usage: "create a wallet (python deps: sha3, coincurve)"
    options:
      name:
        usage: "basename for wallet files .key, .pub and .addr"
        default: genesis-wallet
      nodedir:
        usage: "parent dir for node --datadir, defaults to DEFAULT_NODE_DIR"
        default: ""

    run:
      - task: set-build-env
      - command:
          exec: |
            set -e
            export GOPATH=$(cd $QUORUM_GOPATH; pwd)

            [ -n "${nodedir}" ] && NODE_DIR="${nodedir}" || NODE_DIR=${DEFAULT_NODE_DIR}
            mkdir -p ${NODE_DIR} && cd ${NODE_DIR}

            cat <<PYEND | python
            import secrets, coincurve, sha3

            key = sha3.keccak_256(secrets.token_bytes(32)).digest()
            pub = coincurve.PublicKey.from_valid_secret(key).format(compressed=False)[1:]
            addr = "0x" + sha3.keccak_256(pub).digest()[-20:].hex()

            for var, mode in [("key", "b"), ("pub", "b"), ("addr", "")]:
                with open(f"${name}.{var}", "w" + mode) as f:
                    f.write(locals()[var])

            print(addr)
            PYEND
